
\edef\etatcatcode{\the\catcode`\@}
\catcode`\@=11

\ifx\e@alloc\@undefined\else
\expandafter\endinput
\fi

%
% fixes to etex.src, 
% These could and probably should be made directly in an
% update to etex.src which already has some luatex-specific
% code, but does not define the correct range for luatex.

% 2015-07-13 higher range in luatex
\edef \et@xmaxregs {\ifx\directlua\@undefined 32768\else 65536\fi}
% luatex/xetex also allow more math fam
\edef \et@xmaxfam {\ifx\Umathchar\@undefined\sixt@@n\else\@cclvi\fi}

\count 270=\et@xmaxregs % locally allocates \count registers 32767, 32766, ...
\count 271=\et@xmaxregs % ditto for \dimen registers
\count 272=\et@xmaxregs % ditto for \skip registers
\count 273=\et@xmaxregs % ditto for \muskip registers
\count 274=\et@xmaxregs % ditto for \box registers
\count 275=\et@xmaxregs % ditto for \toks registers
\count 276=\et@xmaxregs % ditto for \marks classes

% and 256 or 16 fam
\outer\def\newfam{\alloc@8\fam\chardef\et@xmaxfam}

% end of proposed changes to etex.src
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Switch to global cf luatex.sty to leave room for inserts
% not really needed for luatex but possibly most compatible
% with existing use.
\let\newcount\globcount
\let\newdimen\globdimen
\let\newskip\globskip
\let\newbox\globbox

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



% define\e@alloc as in latex (the existing macros in etex.src
% hard to extend to further register types as they assume specific
% 26x and 27x count range. For compatibility the existing register
% allocation is not changed.


\def\e@alloc#1#2#3#4#5#6{%
  \global\advance#3\@ne
  \e@ch@ck{#3}{#4}{#5}#1%
  \allocationnumber#3\relax
  \global#2#6\allocationnumber
  \wlog{\string#6=\string#1\the\allocationnumber}}%
\gdef\e@ch@ck#1#2#3#4{%
  \ifnum#1<#2\else
    \ifnum#1=#2\relax
      #1\@cclvi
      \ifx\count#4\advance#1 10 \fi
    \fi
    \ifnum#1<#3\relax
    \else
      \errmessage{No room for a new \string#4}%
    \fi
  \fi}%


%%%%%%
\long\def \@gobble #1{}
\long\def\@firstofone#1{#1}

% fix up allocations not to clash with etex.src

\newcount\e@alloc@attribute@count
\newcount\e@alloc@ccodetable@count
\newcount\e@alloc@luafunction@count
\newcount\e@alloc@whatsit@count

% input the main code
\input ltluatex.sty\relax


\catcode`\@=\etatcatcode\relax
